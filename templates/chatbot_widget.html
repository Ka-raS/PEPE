<div id="pepe-chatbot-container">
    <button id="chatbot-toggler" class="btn btn-primary rounded-circle shadow-lg d-flex align-items-center justify-content-center">
        <i class="bi bi-robot fs-4"></i>
    </button>

    <div id="chatbot-window" class="card shadow-lg border-0 rounded-card d-none">
        <div class="card-header bg-primary text-white rounded-card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-robot me-2"></i>PEPE - Trợ lý ảo</h6>
            <button id="chatbot-close" class="btn btn-sm btn-link text-white text-decoration-none">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="card-body p-0">
            <div id="chat-messages" class="p-3">
                <div class="message bot-message mb-3">
                    <div class="d-inline-block bg-light p-2 rounded-3 text-dark shadow-sm">
                        Xin chào! Mình là trợ lý ảo của hệ thống diễn đàn học tập PEPE. Bạn cần tìm tài liệu gì hôm nay?
                    </div>
                </div>
            </div>
        </div>

        <div class="card-footer bg-white border-top-0 p-3">
            <form id="chat-form" class="d-flex gap-2">
                <input type="text" id="chat-input" class="form-control rounded-pill bg-light border-0" placeholder="Hỏi gì đó..." autocomplete="off">
                <button type="submit" class="btn btn-primary rounded-circle" style="width: 38px; height: 38px;">
                    <i class="bi bi-send-fill small"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<style>
    #pepe-chatbot-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1050;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    #chatbot-toggler {
        width: 60px;
        height: 60px;
        transition: transform 0.3s;
        background: linear-gradient(135deg, #0d6efd, #0a58ca);
        border: none;
    }

    #chatbot-toggler:hover {
        transform: scale(1.1);
    }

    #chatbot-window {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 350px;
        height: 450px;
        display: flex;
        flex-direction: column;
        animation: slideIn 0.3s ease-out;
    }

    #chat-messages {
        height: 320px;
        overflow-y: auto;
        background-color: #fff;
    }

    .message {
        font-size: 0.95rem;
        line-height: 1.4;
    }

    .bot-message {
        text-align: left;
        margin-right: 20%;
    }

    .user-message {
        text-align: right;
        margin-left: 20%;
    }

    .user-message .content {
        background: linear-gradient(135deg, #0d6efd, #0a58ca);
        color: white;
        padding: 8px 12px;
        border-radius: 12px 12px 0 12px;
        display: inline-block;
        box-shadow: 0 2px 5px rgba(13, 110, 253, 0.2);
    }

    .bot-message .content {
        background-color: #f8f9fa;
        color: #212529;
        padding: 8px 12px;
        border-radius: 12px 12px 12px 0;
        display: inline-block;
        border: 1px solid #e9ecef;
    }

    .chat-link {
        display: block;
        margin-top: 5px;
        color: #0d6efd;
        text-decoration: none;
        font-size: 0.9em;
        background: white;
        padding: 5px 10px;
        border-radius: 5px;
        border: 1px solid #dee2e6;
        transition: all 0.2s;
    }
    
    .chat-link:hover {
        background: #e9ecef;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggler = document.getElementById('chatbot-toggler');
    const window = document.getElementById('chatbot-window');
    const closeBtn = document.getElementById('chatbot-close');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('chat-input');
    const messagesContainer = document.getElementById('chat-messages');

    // Toggle Chat Window
    toggler.addEventListener('click', () => {
        window.classList.remove('d-none');
        toggler.classList.add('d-none');
        input.focus();
    });

    closeBtn.addEventListener('click', () => {
        window.classList.add('d-none');
        toggler.classList.remove('d-none');
    });

    // Gửi tin nhắn
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;

        // Hiển thị tin nhắn người dùng
        addMessage(text, 'user');
        input.value = '';

        // Hiển thị loading
        const loadingId = addMessage('<i class="bi bi-three-dots"></i>', 'bot', true);

        try {
            const response = await fetch('{% url "home:chatbot_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ message: text })
            });

            const data = await response.json();
            
            // Xóa loading và hiện phản hồi
            removeMessage(loadingId);
            addMessage(data.response, 'bot', false, data.links);

        } catch (error) {
            console.error('Error:', error);
            removeMessage(loadingId);
            addMessage('Xin lỗi, mình đang gặp chút sự cố kết nối.', 'bot');
        }
    });

    function addMessage(text, sender, isLoading = false, links = []) {
        const div = document.createElement('div');
        div.className = `message ${sender}-message mb-3`;
        const id = 'msg-' + Date.now() + '-' + Math.random().toString(16).slice(2);
        div.id = id;

        let linkHtml = '';
        if (links && links.length > 0) {
            linkHtml = '<div class="mt-2">';
            links.forEach(link => {
                linkHtml += `<a href="${link.url}" class="chat-link"><i class="bi bi-link-45deg"></i> ${link.text}</a>`;
            });
            linkHtml += '</div>';
        }

        div.innerHTML = `
            <div class="content ${sender === 'bot' ? 'bg-light text-dark' : ''}">
                ${text}
                ${linkHtml}
            </div>
        `;
        messagesContainer.appendChild(div);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        return id;
    }

    function removeMessage(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }

    // Hàm lấy CSRF Token từ cookie của Django
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>