{% extends 'base.html' %}
{% load static %}

{% block title %}Tạo Bài Kiểm Tra Mới{% endblock %}

{% block main %}
<div class="container mt-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'forum:index' %}" class="text-decoration-none">
                    <i class="bi bi-house"></i> Diễn đàn
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'forum:subject_detail' subject_id %}" class="text-decoration-none">
                    Môn học
                </a>
            </li>
            <li class="breadcrumb-item active">Tạo bài kiểm tra</li>
        </ol>
    </nav>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm border-0 rounded-card">
                <div class="card-header bg-success text-white rounded-card-header py-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-file-earmark-text fs-3 me-3"></i>
                        <div>
                            <h4 class="card-title mb-0 fw-bold">Tạo Bài Kiểm Tra Mới</h4>
                            <small class="opacity-75">Tạo bài kiểm tra và thêm câu hỏi ngay</small>
                        </div>
                    </div>
                </div>

                <div class="card-body p-4">
                    <!-- Thông tin môn học -->
                    <div class="alert alert-info border-0 rounded-card mb-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-book fs-4 me-3"></i>
                            <div>
                                <h5 class="alert-heading mb-1">Thông tin môn học</h5>
                                <p class="mb-0">
                                    <strong>Môn học:</strong> 
                                    <span id="subject-name">Đang tải...</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <form method="post" id="test-form">
                        {% csrf_token %}
                        
                        <!-- Tiêu đề -->
                        <div class="mb-4">
                            <label for="title" class="form-label fw-semibold">
                                Tiêu đề bài kiểm tra <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control form-control-lg rounded-input" id="title" name="title" 
                                   placeholder="Nhập tiêu đề bài kiểm tra..." required
                                   maxlength="200">
                            <div class="form-text">Tiêu đề nên ngắn gọn và mô tả rõ nội dung bài kiểm tra</div>
                        </div>

                        <!-- Mô tả -->
                        <div class="mb-4">
                            <label for="content" class="form-label fw-semibold">Mô tả bài kiểm tra</label>
                            <textarea class="form-control rounded-input" id="content" name="content" rows="4"
                                      placeholder="Mô tả chi tiết về bài kiểm tra, yêu cầu, hướng dẫn làm bài..."></textarea>
                            <div class="form-text">Cung cấp thông tin hữu ích cho người làm bài</div>
                        </div>

                        <div class="row">
                            <!-- Thời gian làm bài -->
                            <div class="col-md-6 mb-4">
                                <label for="time_limit" class="form-label fw-semibold">
                                    Thời gian làm bài (phút)
                                </label>
                                <input type="number" class="form-control rounded-input" id="time_limit" name="time_limit" 
                                       value="60" min="1" max="480" required>
                                <div class="form-text">Thời gian tối đa để hoàn thành bài kiểm tra</div>
                            </div>

                            <!-- Số lần làm bài tối đa -->
                            <div class="col-md-6 mb-4">
                                <label for="max_attempts" class="form-label fw-semibold">
                                    Số lần làm bài tối đa
                                </label>
                                <input type="number" class="form-control rounded-input" id="max_attempts" name="max_attempts" 
                                       value="1" min="1" max="10" required>
                                <div class="form-text">Số lần người dùng được phép làm bài kiểm tra</div>
                            </div>
                        </div>

                        <!-- Hạn nộp bài -->
                        <div class="mb-4">
                            <label for="due_date" class="form-label fw-semibold">Hạn nộp bài</label>
                            <input type="datetime-local" class="form-control rounded-input" id="due_date" name="due_date">
                            <div class="form-text">
                                Để trống nếu bài kiểm tra không có hạn nộp cụ thể
                            </div>
                        </div>

                        <!-- Thông báo lỗi -->
                        {% if messages %}
                        <div class="alert alert-danger border-0 rounded-card">
                            <h6 class="alert-heading mb-2">Thông báo:</h6>
                            <ul class="mb-0">
                                {% for message in messages %}
                                <li>{{ message }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <!-- Nút hành động -->
                        <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                            <a href="{% url 'forum:subject_detail' subject_id %}" class="btn btn-outline-secondary rounded-btn">
                                <i class="bi bi-arrow-left"></i> Quay lại
                            </a>
                            <div>
                                <button type="reset" class="btn btn-outline-danger rounded-btn me-2">
                                    <i class="bi bi-arrow-clockwise"></i> Đặt lại
                                </button>
                                <button type="submit" class="btn btn-success rounded-btn">
                                    <i class="bi bi-check-circle"></i> Tạo bài kiểm tra
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block style %}
<style>
/* Form input rounded */
.rounded-input {
    border-radius: 10px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.rounded-input:focus {
    border-color: #198754;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
}

/* Tab rounded */
.rounded-tab {
    border-radius: 10px 10px 0 0;
    transition: all 0.3s ease;
}

.rounded-tab.active {
    background-color: #fff;
    border-color: #dee2e6 #dee2e6 #fff;
}

/* Question item */
.question-item {
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 10px;
    transition: all 0.2s ease;
}

.question-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
}

.question-item.selected {
    border-color: #198754;
    background-color: #f8fff9;
}

/* Selected question item */
.selected-question-item {
    background-color: #f8f9fa;
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 8px;
    border-left: 4px solid #198754;
    transition: all 0.2s ease;
}

.selected-question-item:hover {
    background-color: #e9ecef;
}

/* Input group rounded */
.input-group-text {
    background-color: #e9ecef;
    border: 2px solid #e9ecef;
}

.input-group .form-control {
    border: 2px solid #e9ecef;
}

.btn-outline-danger.rounded-btn:not(header .btn-outline-danger) {
    background: linear-gradient(135deg, #dc3545, #bb2d3b);
    color: white;
    border: none;
}

.btn-outline-danger.rounded-btn:not(header .btn-outline-danger):hover {
    background: linear-gradient(135deg, #bb2d3b, #a02834);
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
}
</style>
{% endblock %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Biến lưu trữ câu hỏi đã chọn
    let selectedQuestions = [];
    let availableQuestions = [];

    // Khởi tạo
    loadSubjectInfo();
    loadQuestionBank();
    setupEventListeners();

    function loadSubjectInfo() {
        // Giả lập load thông tin môn học
        document.getElementById('subject-name').textContent = 'Môn học #{{ subject_id }}';
    }

    function loadQuestionBank() {
        // Giả lập load câu hỏi từ ngân hàng
        setTimeout(() => {
            const container = document.getElementById('question-bank-container');
            container.innerHTML = `
                <div class="question-list">
                    <div class="question-item" data-id="1">
                        <div class="form-check">
                            <input class="form-check-input question-checkbox" type="checkbox" value="1">
                            <label class="form-check-label w-100">
                                <div class="d-flex justify-content-between">
                                    <strong>Câu hỏi trắc nghiệm mẫu 1</strong>
                                    <span class="badge bg-info">Trắc nghiệm</span>
                                </div>
                                <small class="text-muted">Nội dung câu hỏi trắc nghiệm mẫu...</small>
                            </label>
                        </div>
                    </div>
                    <div class="question-item" data-id="2">
                        <div class="form-check">
                            <input class="form-check-input question-checkbox" type="checkbox" value="2">
                            <label class="form-check-label w-100">
                                <div class="d-flex justify-content-between">
                                    <strong>Câu hỏi tự luận mẫu</strong>
                                    <span class="badge bg-warning">Tự luận</span>
                                </div>
                                <small class="text-muted">Nội dung câu hỏi tự luận mẫu...</small>
                            </label>
                        </div>
                    </div>
                    <div class="question-item" data-id="3">
                        <div class="form-check">
                            <input class="form-check-input question-checkbox" type="checkbox" value="3">
                            <label class="form-check-label w-100">
                                <div class="d-flex justify-content-between">
                                    <strong>Câu hỏi trắc nghiệm mẫu 2</strong>
                                    <span class="badge bg-info">Trắc nghiệm</span>
                                </div>
                                <small class="text-muted">Nội dung câu hỏi trắc nghiệm mẫu khác...</small>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" id="add-selected-questions">
                        <i class="bi bi-plus-circle"></i> Thêm câu hỏi đã chọn
                    </button>
                </div>
            `;

            // Thêm event listener cho nút thêm câu hỏi đã chọn
            document.getElementById('add-selected-questions').addEventListener('click', addSelectedFromBank);
        }, 1000);
    }

    function setupEventListeners() {
        // Toggle fields theo loại câu hỏi
        document.getElementById('question_type').addEventListener('change', function() {
            const type = this.value;
            document.getElementById('multiple_choice_fields').style.display = 
                type === 'multiple_choice' ? 'block' : 'none';
            document.getElementById('essay_fields').style.display = 
                type === 'essay' ? 'block' : 'none';
        });

        // Thêm câu hỏi mới
        document.getElementById('add-new-question').addEventListener('click', addNewQuestion);

        // Xử lý form submit
        document.getElementById('test-form').addEventListener('submit', function(e) {
            if (selectedQuestions.length === 0) {
                e.preventDefault();
                alert('Vui lòng thêm ít nhất một câu hỏi vào bài kiểm tra');
                return;
            }

            // Thêm các câu hỏi đã chọn vào form data
            selectedQuestions.forEach((question, index) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected_questions';
                input.value = JSON.stringify(question);
                this.appendChild(input);
            });
        });
    }

    function addSelectedFromBank() {
        const checkboxes = document.querySelectorAll('.question-checkbox:checked');
        checkboxes.forEach(checkbox => {
            const questionItem = checkbox.closest('.question-item');
            const questionId = questionItem.dataset.id;
            const questionText = questionItem.querySelector('strong').textContent;
            const questionType = questionItem.querySelector('.badge').textContent;
            const questionContent = questionItem.querySelector('small').textContent;

            // Kiểm tra xem câu hỏi đã được thêm chưa
            if (!selectedQuestions.find(q => q.id === questionId)) {
                const question = {
                    id: questionId,
                    type: questionType === 'Trắc nghiệm' ? 'multiple_choice' : 'essay',
                    content: questionContent,
                    text: questionText,
                    source: 'bank'
                };

                selectedQuestions.push(question);
                addQuestionToSelectedList(question);
            }
        });

        updateSelectedCount();
    }

    function addNewQuestion() {
        const type = document.getElementById('question_type').value;
        const content = document.getElementById('question_content').value.trim();
        const explanation = document.getElementById('explanation').value.trim();

        if (!content) {
            alert('Vui lòng nhập nội dung câu hỏi');
            return;
        }

        let questionData = {
            id: 'new_' + Date.now(),
            type: type,
            content: content,
            explanation: explanation,
            source: 'new'
        };

        if (type === 'multiple_choice') {
            const options = {};
            document.querySelectorAll('.option-input').forEach((input, index) => {
                const optionValue = input.value.trim();
                if (optionValue) {
                    options[String.fromCharCode(65 + index)] = optionValue;
                }
            });
            questionData.options = options;
        } else if (type === 'essay') {
            questionData.word_limit = document.getElementById('word_limit').value;
        }

        selectedQuestions.push(questionData);
        addQuestionToSelectedList(questionData);

        // Reset form
        document.getElementById('question_content').value = '';
        document.getElementById('explanation').value = '';
        document.querySelectorAll('.option-input').forEach(input => input.value = '');
        document.getElementById('word_limit').value = '0';

        updateSelectedCount();
    }

    function addQuestionToSelectedList(question) {
        const container = document.getElementById('selected-questions-list');
        
        if (container.querySelector('.text-muted')) {
            container.innerHTML = '';
        }

        const questionElement = document.createElement('div');
        questionElement.className = 'selected-question-item';
        questionElement.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <strong>${question.text || question.content.substring(0, 50)}...</strong>
                    <br>
                    <small class="text-muted">
                        ${question.content}
                        ${question.source === 'new' ? '<span class="badge bg-success ms-2">Mới</span>' : ''}
                    </small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger remove-question" 
                        data-id="${question.id}">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;

        container.appendChild(questionElement);

        // Thêm event listener cho nút xóa
        questionElement.querySelector('.remove-question').addEventListener('click', function() {
            const questionId = this.dataset.id;
            removeQuestion(questionId);
        });
    }

    function removeQuestion(questionId) {
        selectedQuestions = selectedQuestions.filter(q => q.id !== questionId);
        updateSelectedList();
        updateSelectedCount();
    }

    function updateSelectedList() {
        const container = document.getElementById('selected-questions-list');
        container.innerHTML = '';

        if (selectedQuestions.length === 0) {
            container.innerHTML = '<p class="text-muted mb-0">Chưa có câu hỏi nào được chọn</p>';
            return;
        }

        selectedQuestions.forEach(question => {
            addQuestionToSelectedList(question);
        });
    }

    function updateSelectedCount() {
        document.getElementById('selected-count').textContent = selectedQuestions.length;
    }

    // Đặt min datetime cho hạn nộp bài (ngày hiện tại)
    const dueDateInput = document.getElementById('due_date');
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    
    dueDateInput.min = `${year}-${month}-${day}T${hours}:${minutes}`;
});
</script>
{% endblock %}