{% extends 'base.html' %}
{% load static %}

{% block title %}Hồ sơ cá nhân{% endblock %}

{% block main %}

{% if messages %}
  {% for message in messages %}
    <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endfor %}
{% endif %}

<div class="row g-4">

  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body p-4">

        <div class="d-flex flex-column flex-md-row align-items-center text-center text-md-start mb-4 pb-4 border-bottom">
          <!-- url 'accounts:update_avatar' -->
          <form id="avatar-form" method="POST" action="#" enctype="multipart/form-data" class="position-relative me-md-4 mb-3 mb-md-0">
            {% csrf_token %}
            {% if avatar_path %}
              <img id="avatar-preview" src="{{ avatar_path }}" class="rounded-circle profile-avatar" alt="Avatar">
            {% else %}
              <img id="avatar-preview" src="{% static 'images/avatar_default.png' %}" class="rounded-circle profile-avatar" alt="Avatar">
            {% endif %}
              <input type="file" name="avatar" id="avatar-input" accept="image/*" class="d-none">
              <label for="avatar-input" class="btn btn-primary btn-sm rounded-circle position-absolute bottom-0 end-0" style="width: 35px; height: 35px; cursor: pointer;" title="Đổi ảnh đại diện">
                <i class="bi bi-camera-fill"></i>
              </label>
          </form>

          <div class="mt-3 mt-md-0">
            <h2 id="profile-header-name" class="h3 mb-1">{{ full_name|default:username }}</h2>
            <p id="profile-header-major" class="text-muted mb-2">
              {% if major_name %}
                Sinh viên Khoa {{ major_name }}
              {% else %}
                Chưa cập nhật chuyên ngành
              {% endif %}
            </p>
            <span class="badge bg-success"><i class="bi bi-patch-check-fill me-1"></i>Tài khoản đã xác thực</span>
          </div>
        </div>
        <!-- url 'accounts:index_student' -->
        <form method="POST" action="{% url 'accounts:index' %}">
          {% csrf_token %}
          <div class="info-section">
            <div class="section-header">
              <h5 class="mb-0">Thông tin cá nhân</h5>
              <button class="btn btn-outline-primary btn-sm" id="edit-btn" type="button" onclick="toggleEditMode(true)">
                <i class="bi bi-pencil-fill me-1"></i>Chỉnh sửa
              </button>
            </div>

            <div class="info-grid">
              <div class="info-item">
                <label>Họ và tên</label>
                <p class="info-value">{{ full_name|default:"Chưa cập nhật" }}</p>
                <input type="text" name="full_name" class="form-control info-input" value="{{ full_name|default:"Chưa đặt hồ sơ" }}">
              </div>
              <div class="info-item">
                <label>Tên đăng nhập</label>
                <p class="info-value">{{ username }}</p>
                <input type="text" class="form-control info-input" value="{{ username }}" disabled>
              </div>
              <div class="info-item">
                <label>Email</label>
                <p class="info-value">{{ email }}</p>
                <input type="email" class="form-control info-input" value="{{ email }}" disabled>
              </div>

              <div class="info-item">
                <label for="major_id">Ngành</label>
                <p class="info-value" id="major-display">
                  {{ major_name|default:"Chưa cập nhật" }}
                </p>
                <div class="info-input" id="major-input" style="display: none;">
                  <select name="major_id" id="major_id" class="form-control">
                    <option value="">-- Chọn ngành --</option>
                    {% for i_major in all_major %}
                      <option value="{{ i_major.id }}" {% if i_major.id == current_major_id %}selected{% endif %}>
                        {{ i_major.name }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>

            <div id="action-buttons" class="mt-4" style="display: none;">
              <button class="btn btn-primary" type="submit"><i class="bi bi-save me-1"></i>Lưu thay đổi</button>
              <button class="btn btn-secondary ms-2" type="button" onclick="toggleEditMode(false)">Hủy</button>
            </div>
          </div>
        </form>

      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="sticky-top" style="top: 20px;">
      <div class="d-grid gap-4">
        <div class="card shadow-sm">
          <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-activity me-2"></i>Thống kê hoạt động</h6>
          </div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>Tài liệu đã tải lên</span>
              <strong class="badge bg-primary rounded-pill">{{ uploads_count }}</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>Tổng coin đã kiếm</span>
              <strong><i class="bi bi-coin"></i> {{ coins }}</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>Bài kiểm tra đã làm</span>
              <strong class="badge bg-info rounded-pill">{{ tests_taken }}</strong>
            </li>
          </ul>
        </div>

        <div class="card shadow-sm">
          <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Hoạt động gần đây</h6>
          </div>
          <div class="card-body">
            <ul class="list-unstyled small mb-0">
              <li class="mb-2"><i class="bi bi-cloud-upload text-primary me-2"></i>Tải lên tài liệu "Đề cương Vi xử lý".</li>
              <li class="mb-2"><i class="bi bi-pencil-square text-success me-2"></i>Hoàn thành bài kiểm tra CSDL.</li>
              <li><i class="bi bi-download text-info me-2"></i>Tải về tài liệu "Slide Giải tích 1".</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block script %}
<script>
  const avatarInput = document.getElementById('avatar-input');
  const avatarPreview = document.getElementById('avatar-preview');
  const avatarForm = document.getElementById('avatar-form');

  if (avatarInput && avatarPreview && avatarForm) {
    avatarInput.addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          avatarPreview.src = e.target.result;
          avatarForm.submit();
        };
        reader.readAsDataURL(file);
      }
    });
  }

  function toggleEditMode(isEditing) {
    const infoSection = document.querySelector('.info-section');
    const editBtn = document.getElementById('edit-btn');
    const actionBtns = document.getElementById('action-buttons');
    const infoValues = infoSection.querySelectorAll('.info-value');
    const infoInputs = infoSection.querySelectorAll('.info-input');
    const majorDisplay = document.getElementById('major-display');
    const majorInput = document.getElementById('major-input');

    if (isEditing) {
      editBtn.style.display = 'none';
      actionBtns.style.display = 'block';
      infoValues.forEach(el => el.style.display = 'none');
      infoInputs.forEach(el => el.style.display = 'block');
      if (majorDisplay && majorInput) {
        majorDisplay.style.display = 'none';
        majorInput.style.display = 'block';
      }
    } else {
      editBtn.style.display = 'block';
      actionBtns.style.display = 'none';
      infoValues.forEach(el => el.style.display = 'block');
      infoInputs.forEach(el => el.style.display = 'none');
      if (majorDisplay && majorInput) {
        majorDisplay.style.display = 'block';
        majorInput.style.display = 'none';
      }
    }
  }
</script>

<style>
  body {
    background-color: #f8f9fa;
  }

  .bg-custom-dark {
    background-color: #2c3e50 !important;
  }

  .bg-custom-secondary {
    background-color: #34495e !important;
  }

  .text-custom-blue {
    color: #3498db !important;
  }

  .profile-avatar {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border: 4px solid var(--bs-primary);
    display: block;
    margin-bottom: 0.5rem;
  }

  .info-section {
    margin-bottom: 2rem;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #dee2e6;
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }

  .info-item label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.25rem;
    display: block;
  }

  .info-value {
    padding: 0.5rem 0.75rem;
    background: #f1f3f5;
    border-radius: 0.25rem;
    border-left: 3px solid var(--bs-primary);
    min-height: calc(1.5em + 1rem + 2px);
    display: flex;
    align-items: center;
  }

  .info-input {
    display: none;
  }
</style>
{% endblock %}